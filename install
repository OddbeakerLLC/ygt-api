#!/bin/bash
# Install script for ygt-api

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_NAME="ygt-api"
INSTALL_DIR="/usr/local/bin"
SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_NAME"
INSTALL_PATH="$INSTALL_DIR/$SCRIPT_NAME"

echo "YGT API Wrapper Installation"
echo "============================="
echo

# Check if script exists
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "Error: $SCRIPT_NAME not found in $SCRIPT_DIR" >&2
    exit 1
fi

# Check if install directory exists
if [ ! -d "$INSTALL_DIR" ]; then
    echo "Error: Installation directory $INSTALL_DIR does not exist" >&2
    exit 1
fi

# Check if we need sudo
if [ ! -w "$INSTALL_DIR" ]; then
    SUDO="sudo"
    echo "Note: Installation requires sudo privileges"
    echo
else
    SUDO=""
fi

# Check if already installed
if [ -L "$INSTALL_PATH" ]; then
    EXISTING_TARGET=$(readlink "$INSTALL_PATH")
    if [ "$EXISTING_TARGET" = "$SCRIPT_PATH" ]; then
        echo "✓ $SCRIPT_NAME is already installed and up to date"
        echo "  Symlink: $INSTALL_PATH -> $SCRIPT_PATH"
        exit 0
    else
        echo "Warning: A symlink already exists at $INSTALL_PATH"
        echo "  Current target: $EXISTING_TARGET"
        echo "  New target would be: $SCRIPT_PATH"
        echo
        read -p "Replace existing symlink? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Installation cancelled"
            exit 1
        fi
        $SUDO rm "$INSTALL_PATH"
    fi
elif [ -f "$INSTALL_PATH" ]; then
    echo "Warning: A file already exists at $INSTALL_PATH"
    echo
    read -p "Replace with symlink? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Installation cancelled"
        exit 1
    fi
    $SUDO rm "$INSTALL_PATH"
fi

# Make script executable
chmod +x "$SCRIPT_PATH"

# Create symlink
echo "Installing $SCRIPT_NAME..."
$SUDO ln -s "$SCRIPT_PATH" "$INSTALL_PATH"

echo
echo "✓ Installation complete!"
echo
echo "  Symlink created: $INSTALL_PATH -> $SCRIPT_PATH"
echo
echo "You can now run 'ygt-api' from anywhere on your system."
echo
echo "Next steps:"
echo "  1. Get your Access Token from https://ygt.oddbeaker.com"
echo "  2. Set your token: export YGT_TOKEN=\"your_token_here\""
echo "  3. Run: ygt-api --help"
echo
